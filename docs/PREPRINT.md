# HV Server Precise

<!-- ### Взаимодействие с системой Online -->

Для управления новой высоковольтной системой (ссылка на препринт Сергея) был разработан модуль управления, API-совместимый с системой сбора данных Online, использующейся на установке.

<!-- блок-схема с 3 стр препринта Сергея -->


<!-- драйвера только под windows хорошие -->
<!-- Для обратной совместимости API сервера полностью повторяет старый вариант. -->

## Код программы

Сервер написан на Python с использованием asyncio, aiohttp и pyvisa.
Код писался с расчетом на переиспользование (в предстоящем апгрейде детекторного модуля)

### Общие элементы
<!-- С расчетом на апгрейд модуля детектора были сделаны следующие обобщения (code reuse?) -->

Был создан абстрактный класс (интерфейс) для управления аппаратной системой  ([HardwareManager](utils/manager.py)). Ниже представлена его схема работы.

<!-- https://app.diagrams.net/#G1lnyGA1NQt5rZ9bE36kCLfsrnZRfgtakG -->
![message_flow.drawio.svg](./img/message_flow.drawio.svg)

HardwareManager имеет методы `start`, `stop`, входящий и исходящий очереди сообщений (`input` и `output` соответственно).

Предполагается, что в методе `start()` будет производить инициализацию устройств и запускать необходимые потоки обработки (asyncio Task). Метод `stop()` должен соответственно останавливать запущенные потоки и, при необходимости, производить корректную остановку устройств.

Очередь `input` содержит приходящие команды (в декодированном виде). Получить очередное сообщение можно командой:
```python
message:  = await self.input.get() # returns {"meta": dict, "data": bytes}
```
<!-- добавить ссылку https://zguide.zeromq.org/docs/chapter5/ -->
Ответы отправляются через очередь `output`, работающую в режиме Publisher (сообщения отправляются всем подписчикам). Пример отправки сообщения:
```python
self.output.publish(dict(meta=dict(
    type="answer",
    answer_type='set_voltage',
    block="1",
    status="ok"
), data= b''))
```

Взаимодействие с классом осуществляется через коннекторы, которые подключаются к  `HardwareManager.input` и `HardwareManager.output`. Они осуществляют кодирование/декодирование сообщений и отправку/прием их по транспортным протоколам. 
<!-- в input записывается любая команда, пришедшая на любой коннектор; любой ответ, записанный в output будет передан всем соединениям со всех коннекторов -->

На данный момент сделано 2 коннектора
- [DataForge TCP/IP](../utils/transport/socket.py) - реализация стандартного для Online транспортного протокола. Данный коннектор передает пакеты в формате [Envelope](ссылка) по TCP/IP соединению и используется для взаимодействия с другими модулями Online. 
<!-- реализован с помощью asyncio create_server -->
<!-- полная совместимость -->
- [websocket](../utils/transport/socket.py) - данный коннектор передает только текстовые метаданные в формате JSON и предназначен для управления устройством через web интерфейс (для отладки). Разделение пакетов осуществляется на стороне протокола. 
<!-- реализован с помощью aiohttp -->
<!-- (лень писать парсер) -->

### Реализация
В случае высоковольтной системы мы запускаем 2 потока:
- поток обработки входящих команд `HVManager.__handle_input()`. В нем производится считывание пакета сообщения из очереди `input`, проверка корректности входной команды (с помощью [JSON-Schema](../commands.schema.json)), проверка занятости сервера, запуск потока обработки конкретной команды (в случае выполнения предыдущих 2-х условий) и проверка успешности обработки команды.
- поток опроса вольтметра в цикле (`HVManager.__monitor_voltage`). В нем производится инициализация вольтметра и запускается цикл считывания напряжения.

Ниже представлена блок-схема работы `HVManager`: 
<!-- добавить https://app.diagrams.net/#G1ONdv2RmA4S19M1r9XUlKFw1nFSLeSrH4 -->
![hv_manager.drawio.svg](./img/hv_manager.drawio.svg)

<!-- Виртуальная часть
имитирует плавное изменение напряжения к желаемому с постоянной скоростью + случайная ошибка. -->

<!-- написать про коррекцию напряжения -->

<!-- написать про веб-интерфейс и его url -->


